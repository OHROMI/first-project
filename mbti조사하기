import streamlit as st
import pandas as pd
import os

st.set_page_config(page_title="MBTI ë¹„êµ ì„œë¹„ìŠ¤ ğŸ¾", page_icon="ğŸ¦Š")

# ê²½ë¡œ ì„¤ì •
DATA_DIR = "data"
os.makedirs(DATA_DIR, exist_ok=True)

# í˜ì´ì§€ ì„ íƒ
page = st.sidebar.radio("í˜ì´ì§€ ì´ë™", ["ë‚˜ì˜ MBTI ì…ë ¥", "ì¹œêµ¬ê°€ ë³´ëŠ” MBTI ì…ë ¥", "ê²°ê³¼ ë³´ê¸°"])

# ğŸ§â€â™€ï¸ Step 1: ë‚´ê°€ ë³´ëŠ” ë‚˜ì˜ MBTI ì…ë ¥
if page == "ë‚˜ì˜ MBTI ì…ë ¥":
    st.title("ğŸ§  ë‚´ê°€ ìƒê°í•˜ëŠ” ë‚˜ì˜ MBTI")
    name = st.text_input("ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: sujin)")
    my_mbti = st.selectbox("ë‹¹ì‹ ì´ ìƒê°í•˜ëŠ” ìì‹ ì˜ MBTIëŠ”?", [
        "INTJ", "INTP", "ENTP", "ENTJ",
        "INFJ", "INFP", "ENFP", "ENFJ",
        "ISTJ", "ISFJ", "ESTJ", "ESFJ",
        "ISTP", "ISFP", "ESTP", "ESFP"
    ])

    if st.button("ğŸ“¤ ì¹œêµ¬ ë§í¬ ìƒì„±"):
        st.success("âœ… ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ì¹œêµ¬ì—ê²Œ ë³´ë‚´ì„¸ìš”!")
        st.code(f"http://localhost:8501?name={name}&page=ì¹œêµ¬ê°€ ë³´ëŠ” MBTI ì…ë ¥", language="text")
        # ì €ì¥
        pd.DataFrame({"name": [name], "mbti": [my_mbti]}).to_csv(f"{DATA_DIR}/{name}_self.csv", index=False)

# ğŸ‘¯ Step 2: ì¹œêµ¬ê°€ ë³´ëŠ” MBTI ì…ë ¥
elif page == "ì¹œêµ¬ê°€ ë³´ëŠ” MBTI ì…ë ¥":
    name = st.query_params.get("name", "")
    st.title("ğŸ‘€ ì¹œêµ¬ê°€ ë³´ëŠ” MBTI ì…ë ¥")
    
    if not name:
        name = st.text_input("MBTIë¥¼ í‰ê°€í•  ì¹œêµ¬ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:")

    if name:
        selected = st.selectbox(f"{name}ì˜ MBTIëŠ” ë­ë¼ê³  ìƒê°í•´?", [
            "INTJ", "INTP", "ENTP", "ENTJ",
            "INFJ", "INFP", "ENFP", "ENFJ",
            "ISTJ", "ISFJ", "ESTJ", "ESFJ",
            "ISTP", "ISFP", "ESTP", "ESFP"
        ])
        file_path = f"{DATA_DIR}/{name}_votes.csv"
        if st.button("ğŸ“© MBTI íˆ¬í‘œ ì œì¶œ"):
            new_vote = pd.DataFrame({"MBTI": [selected]})
            if os.path.exists(file_path):
                df = pd.read_csv(file_path)
                df = pd.concat([df, new_vote], ignore_index=True)
            else:
                df = new_vote
            df.to_csv(file_path, index=False)
            st.success("íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰")

# ğŸ“Š Step 3: ê²°ê³¼ ë³´ê¸°
elif page == "ê²°ê³¼ ë³´ê¸°":
    st.title("ğŸ“Š ì¹œêµ¬ë“¤ì´ ë³´ëŠ” ë‚˜ì˜ MBTI ê²°ê³¼")

    name = st.text_input("ê²°ê³¼ë¥¼ ë³´ê³  ì‹¶ì€ ì‚¬ëŒì˜ ì´ë¦„ì€?", "")

    if name:
        self_path = f"{DATA_DIR}/{name}_self.csv"
        vote_path = f"{DATA_DIR}/{name}_votes.csv"

        if os.path.exists(self_path):
            self_mbti = pd.read_csv(self_path).iloc[0]["mbti"]
            st.subheader(f"ğŸ™‹ ë‚˜ì˜ ìƒê°: {self_mbti}")
        else:
            st.warning("ë‚˜ì˜ MBTI ì •ë³´ê°€ ì•„ì§ ì…ë ¥ë˜ì§€ ì•Šì•˜ì–´ìš”!")

        if os.path.exists(vote_path):
            votes = pd.read_csv(vote_path)
            counts = votes["MBTI"].value_counts()
            animal_emojis = ["ğŸ¶", "ğŸ±", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¯", "ğŸ¦", "ğŸµ", "ğŸ·", "ğŸ¸", "ğŸ¦„", "ğŸ¥"]
            st.subheader("ğŸ—³ï¸ ì¹œêµ¬ë“¤ì´ ìƒê°í•˜ëŠ” MBTI")
            for i, (mbti, count) in enumerate(counts.items()):
                emoji = animal_emojis[i % len(animal_emojis)]
                st.markdown(f"{emoji} **{mbti}**: {count}í‘œ")
            st.bar_chart(counts)
        else:
            st.info("ì•„ì§ ì¹œêµ¬ë“¤ì˜ íˆ¬í‘œê°€ ì—†ì–´ìš” ğŸ˜¢")
